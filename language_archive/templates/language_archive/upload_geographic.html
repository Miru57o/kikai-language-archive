{% extends 'language_archive/base.html' %}

{% block title %}地理環境データアップロード - 喜界島言語アーカイブ{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .file-upload-area {
        border: 3px dashed var(--secondary-color);
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        background: rgba(151, 192, 92, 0.05);
        transition: all 0.3s;
        cursor: pointer;
    }

    .file-upload-area:hover {
        background: rgba(151, 192, 92, 0.1);
        border-color: var(--primary-color);
    }

    .file-upload-area.dragover {
        background: rgba(151, 192, 92, 0.2);
        border-color: var(--accent-color);
    }

    .file-upload-area.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-dark);
    }

    .required-label::after {
        content: " *";
        color: #dc3545;
    }

    .upload-option {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }

    .upload-option.active {
        border-color: var(--primary-color);
        background-color: rgba(28, 155, 142, 0.05);
    }

    .option-radio {
        transform: scale(1.2);
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">地理環境データの<br class="d-md-none">アップロード</h1>
            <p class="lead">ドローン空撮映像などの地理環境ファイルまたはYouTube URLを登録します</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="upload-section">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}

                    <!-- アップロード方法の選択 -->
                    <div class="mb-4">
                        <label class="form-label required-label">アップロード方法を選択</label>

                        <div class="upload-option" id="fileOption">
                            <div class="form-check">
                                <input class="form-check-input option-radio" type="radio" name="uploadMethod"
                                    id="uploadMethodFile" value="file" checked>
                                <label class="form-check-label" for="uploadMethodFile">
                                    <strong>ファイルをアップロード</strong>
                                    <p class="small text-muted mb-0">コンピュータからファイルを直接アップロードします</p>
                                </label>
                            </div>
                        </div>

                        <div class="upload-option" id="youtubeOption">
                            <div class="form-check">
                                <input class="form-check-input option-radio" type="radio" name="uploadMethod"
                                    id="uploadMethodYoutube" value="youtube">
                                <label class="form-check-label" for="uploadMethodYoutube">
                                    <strong>YouTube URLを入力</strong>
                                    <p class="small text-muted mb-0">YouTubeにアップロード済みの動画URLを使用します</p>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ファイルアップロードエリア -->
                    <div class="mb-4" id="fileUploadSection">
                        <label class="form-label">
                            <i class="fas fa-file-upload"></i> ファイル
                        </label>
                        <div class="file-upload-area" id="fileUploadArea"
                            onclick="document.getElementById('id_file').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <p class="mb-2"><strong>クリックしてファイルを選択</strong></p>
                            <p class="small text-muted">または、ここにファイルをドラッグ＆ドロップ</p>
                            <p class="small text-muted">対応形式: 映像(mp4, mov), 画像(jpg, png)</p>
                            <p class="small text-danger"><strong>※ファイル名は半角英数字、ハイフン(-)、アンダースコア(_)のみにしてください</strong></p>
                        </div>
                        <input type="file" name="file" id="id_file" class="d-none">
                        <div id="fileInfo" class="mt-2"></div>
                    </div>

                    <!-- YouTube URL入力エリア -->
                    <div class="mb-4" id="youtubeUrlSection" style="display: none;">
                        <label for="id_youtube_url" class="form-label">
                            <i class="fab fa-youtube"></i> YouTube URL
                        </label>
                        {{ form.youtube_url }}
                        <small class="form-text text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i>
                            対応フォーマット: https://www.youtube.com/watch?v=... または https://youtu.be/...
                        </small>
                        <div id="youtubePreview" class="mt-3" style="display: none;">
                            <p class="small text-success mb-2">
                                <i class="fas fa-check-circle"></i> プレビュー
                            </p>
                            <div class="ratio ratio-16x9">
                                <iframe id="youtubeIframe" src="" frameborder="0" loading="lazy"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.title.id_for_label }}" class="form-label required-label">タイトル</label>
                            {{ form.title }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.content_type.id_for_label }}"
                                class="form-label required-label">コンテンツ種類</label>
                            {{ form.content_type }}
                        </div>
                    </div>

                    <!--関連情報-->
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label required-label">説明</label>
                        {{ form.description }}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.village.id_for_label }}" class="form-label required-label">集落</label>
                        {{ form.village }}
                    </div>
                    <!--位置情報-->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.latitude.id_for_label }}" class="form-label">緯度</label>
                            <input type="number" step="0.000001" name="latitude" id="id_latitude" class="form-control"
                                placeholder="28.3214">
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.longitude.id_for_label }}" class="form-label">経度</label>
                            <input type="number" step="0.000001" name="longitude" id="id_longitude" class="form-control"
                                placeholder="129.9259">
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="getCurrentLocation">
                            <i class="fas fa-map-marker-alt"></i> 現在地を取得
                        </button>
                        <small class="text-muted ms-2">位置情報サービスを使用して現在地を取得します</small>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.captured_date.id_for_label }}" class="form-label required-label">撮影日</label>
                        {{ form.captured_date }}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-upload"></i> アップロード
                        </button>
                        <a href="{% url 'geographic_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> キャンセル
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const fileInput = document.getElementById('id_file');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const youtubeUrlInput = document.getElementById('id_youtube_url');
    const youtubePreview = document.getElementById('youtubePreview');
    const youtubeIframe = document.getElementById('youtubeIframe');
    const fileUploadSection = document.getElementById('fileUploadSection');
    const youtubeUrlSection = document.getElementById('youtubeUrlSection');
    const uploadMethodFile = document.getElementById('uploadMethodFile');
    const uploadMethodYoutube = document.getElementById('uploadMethodYoutube');
    const fileOption = document.getElementById('fileOption');
    const youtubeOption = document.getElementById('youtubeOption');

    // アップロード方法の切り替え
    function switchUploadMethod(method) {
        if (method === 'file') {
            fileUploadSection.style.display = 'block';
            youtubeUrlSection.style.display = 'none';
            fileInput.removeAttribute('disabled');
            youtubeUrlInput.value = '';
            youtubePreview.style.display = 'none';
            fileOption.classList.add('active');
            youtubeOption.classList.remove('active');
        } else if (method === 'youtube') {
            fileUploadSection.style.display = 'none';
            youtubeUrlSection.style.display = 'block';
            fileInput.value = '';
            fileInfo.innerHTML = '';
            fileUploadArea.style.background = '';
            fileUploadArea.style.borderColor = '';
            fileOption.classList.remove('active');
            youtubeOption.classList.add('active');
        }
    }

    uploadMethodFile.addEventListener('change', function () {
        if (this.checked) switchUploadMethod('file');
    });

    uploadMethodYoutube.addEventListener('change', function () {
        if (this.checked) switchUploadMethod('youtube');
    });

    // 初期状態の設定
    fileOption.classList.add('active');

    // ファイル選択処理
    fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            displayFileInfo(file);
        }
    });

    fileUploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const file = e.dataTransfer.files[0];
        if (file) {
            fileInput.files = e.dataTransfer.files;
            displayFileInfo(file);
        }
    });

    function displayFileInfo(file) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        fileInfo.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>${file.name}</strong> (${sizeMB} MB)
            </div>
        `;

        fileUploadArea.style.background = 'rgba(40, 167, 69, 0.1)';
        fileUploadArea.style.borderColor = '#28a745';
    }

    // YouTube URLのプレビュー 
    youtubeUrlInput.addEventListener('input', function () {
        const url = this.value.trim();
        if (!url) {
            youtubePreview.style.display = 'none';
            return;
        }

        const videoId = extractYoutubeVideoId(url);
        if (videoId) {
            // youtube-nocookie.comを使用
            youtubeIframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1`;
            youtubePreview.style.display = 'block';
        } else {
            youtubePreview.style.display = 'none';
        }
    });

    function extractYoutubeVideoId(url) {
        const patterns = [
            /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/,
            /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/,
            /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]+)/
        ];

        for (let pattern of patterns) {
            const match = url.match(pattern);
            if (match && match[1]) {
                return match[1];
            }
        }
        return null;
    }

    document.getElementById('getCurrentLocation').addEventListener('click', function () {
        if (navigator.geolocation) {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>取得中...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('id_latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('id_longitude').value = position.coords.longitude.toFixed(6);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i> 取得完了';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-map-marker-alt"></i> 現在地を取得';
                    }, 2000);
                },
                (error) => {
                    alert('位置情報の取得に失敗しました: ' + error.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-map-marker-alt"></i> 現在地を取得';
                }
            );
        } else {
            alert('このブラウザは位置情報サービスに対応していません');
        }
    });

    const villageSelect = document.querySelector('select[name="village"]');
    if (villageSelect) {
        villageSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                console.log('集落が選択されました:', selectedOption.text);
            }
        });
    }

    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>アップロード中...';
    });
</script>
{% endblock %}