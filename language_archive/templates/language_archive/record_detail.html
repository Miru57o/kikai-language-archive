{% extends 'language_archive/base.html' %}

{% block title %}{{ record.display_title }} - 言語記録詳細{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        border: none;
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .media-container {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 5px;
        margin-bottom: 2rem;
    }

    .media-container audio,
    .media-container video,
    .media-container img {
        width: 100%;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .info-section {
        background: white;
        padding: 1.5rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        border-left: 4px solid var(--primary-color);
    }

    .info-label {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .youtube-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        z-index: 10;
    }

    .youtube-embed {
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'index' %}">
                            ホーム
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'record_list' %}">
                            言語記録一覧
                        </a>
                    </li>
                    <li class="breadcrumb-item active">
                        {{ record.display_title }}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="detail-card card mb-4">
                <div class="card-body">
                    <h1 class="mb-4">{{ record.display_title }}</h1>

                    <div class="media-container text-center">
                        {% if record.youtube_url and record.get_youtube_embed_url %}
                        <div class="position-relative" style="padding-bottom: 56.25%; height: 0; overflow: hidden;">
                            <iframe class="youtube-embed position-absolute top-0 start-0 w-100 h-100" src="{{ record.get_youtube_embed_url }}" title="{{ record.display_title }}"
                                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen>
                            </iframe>
                        </div>
                        {% elif record.file_type == 'audio' %}
                        <audio controls class="mb-2" preload="metadata">
                            <source src="{{ record.file_path }}">
                            お使いのブラウザは audio タグに対応していません。
                        </audio>
                        {% elif record.file_type == 'video' %}
                        <video controls class="mb-2" playsinline preload="metadata">
                            <source src="{{ record.file_path }}">
                            お使いのブラウザは video タグに対応していません。
                        </video>
                        {% elif record.file_type == 'image' %}
                        <img src="{{ record.file_path }}" alt="{{ record.display_title }}" style="cursor: pointer;">
                        {% endif %}
                    </div>

                    {% if record.youtube_url and record.description %}
                    <div class="info-section">
                        <div class="info-label">説明</div>
                        <p class="mb-0">{{ record.description }}</p>
                    </div>
                    {% endif %}

                    {% if record.meaning is not None and record.meaning != "" %}
                    <div class="info-section">
                        <div class="info-label">意味</div>
                        <p class="mb-0">{{ record.meaning }}</p>
                    </div>
                    {% endif %}

                    {% if record.usage_example is not None and record.usage_example != "" %}
                    <div class="info-section">
                        <div class="info-label">用例</div>
                        <p class="mb-0">{{ record.usage_example }}</p>
                    </div>
                    {% endif %}

                    {% if record.language_frequency %}
                    <div class="info-section">
                        <div class="info-label">この記録での言語使用頻度</div>
                        <p class="mb-0">{{ record.get_language_frequency_display }}</p>
                    </div>
                    {% endif %}

                    {% if record.phonetic_notation %}
                    <div class="info-section">
                        <div class="info-label">音声記号</div>
                        <p class="mb-0" style="font-family: monospace;">{{ record.phonetic_notation }}</p>
                    </div>
                    {% endif %}

                    {% if record.notes %}
                    <div class="info-section">
                        <div class="info-label">備考</div>
                        <p class="mb-0">{{ record.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            {% if record.onomatopoeia_type %}
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-tag"></i> オノマトペ型</h6>
                </div>
                <div class="card-body">
                    <h5 class="mb-2">{{ record.onomatopoeia_type.type_code }}</h5>
                    <h6 class="text-muted mb-3">{{ record.onomatopoeia_type.type_name }}</h6>
                    <p class="small mb-0">{{ record.onomatopoeia_type.description }}</p>
                </div>
            </div>
            {% endif %}

            {% if record.speaker %}
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-user"></i> 話者情報</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>年代:</strong> {{ record.speaker.age_range }}
                    </p>
                    <p class="mb-2">
                        <strong>性別:</strong> {{ record.speaker.get_gender_display }}
                    </p>
                    <p class="mb-0">
                        <a href="{% url 'speaker_records' record.speaker.id %}" class="btn btn-sm btn-outline-success">
                            この話者の他の記録を見る
                        </a>
                    </p>
                </div>
            </div>
            {% endif %}

            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> 位置情報</h6>
                </div>
                <div class="card-body">
                    {% if record.speaker and record.speaker.village %}
                    <p class="mb-2">
                        <strong>集落:</strong> {{ record.speaker.village.name }}
                    </p>
                    <p class="mb-0">
                        <a href="{% url 'village_records' record.speaker.village.id %}"
                            class="btn btn-sm btn-outline-success">
                            この集落の他の記録を見る
                        </a>
                    </p>
                    {% else %}
                    <p class="mb-0 text-muted">集落情報がありません</p>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> メタデータ</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>収録日:</strong> {{ record.recorded_date|date:"Y年m月d日" }}
                    </p>
                    <p class="mb-2">
                        <strong>登録日:</strong> {{ record.created_at|date:"Y年m月d日 H:i" }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // モバイルでの動画再生を最適化
        const videos = document.querySelectorAll('video');
        videos.forEach(function (video) {
            // iOS Safariでの動画再生を最適化
            video.setAttribute('playsinline', 'true');

            // 動画の読み込みエラーを処理
            video.addEventListener('error', function (e) {
                console.log('動画の読み込みエラー:', e);
                // エラーが発生した場合は別タブで開くリンクを表示
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-warning mt-2';
                errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                動画の再生に問題があります。
                <a href="${video.querySelector('source').src}" target="_blank" class="btn btn-sm btn-warning ms-2">
                    <i class="fas fa-external-link-alt"></i> 別タブで開く
                </a>
            `;
                video.parentNode.insertBefore(errorDiv, video.nextSibling);
            });

            // 動画の読み込み開始
            video.addEventListener('loadstart', function () {
                console.log('動画の読み込み開始');
            });

            // 動画の読み込み完了
            video.addEventListener('canplay', function () {
                console.log('動画の再生準備完了');
            });
        });

        // 音声の読み込みエラーを処理
        const audios = document.querySelectorAll('audio');
        audios.forEach(function (audio) {
            audio.addEventListener('error', function (e) {
                console.log('音声の読み込みエラー:', e);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-warning mt-2';
                errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                音声の再生に問題があります。
                <a href="${audio.querySelector('source').src}" target="_blank" class="btn btn-sm btn-warning ms-2">
                    <i class="fas fa-external-link-alt"></i> 別タブで開く
                </a>
            `;
                audio.parentNode.insertBefore(errorDiv, audio.nextSibling);
            });
        });
    });
</script>
{% endblock %}